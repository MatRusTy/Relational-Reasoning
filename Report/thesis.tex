\documentclass[twoside,11pt,openright]{report}

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{a4}
\usepackage{latexsym}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathpartir}
\usepackage{epsfig}
\usepackage[T1]{fontenc}
% \usepackage{mathptmx}
\usepackage{stmaryrd}
\usepackage{color}
\usepackage{epstopdf}
\usepackage{microtype}
\usepackage{hyperref}
\usepackage[en-GB]{datetime2}
\DTMlangsetup[en-GB]{showdayofmonth=false}
\usepackage{lipsum}

\renewcommand*\sfdefault{lmss}
\renewcommand*\ttdefault{txtt}


% Theorems, Corollaries, and Lemmas
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}

\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BNF Grammar
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\BNFdef}{::=}
\newcommand{\ALT}{~|~}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Syntax
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\Keyword}[1]{{\color{blue} \mathsf{#1}}}

\newcommand{\var}{x}
\newcommand{\varB}{y}
\newcommand{\varC}{z}
\newcommand{\expr}{e}
\newcommand{\val}{v}
\newcommand{\valB}{w}
\newcommand{\TT}{()}
\newcommand{\Num}[1]{\overline{#1}}
\newcommand{\True}{\Keyword{true}}
\newcommand{\False}{\Keyword{false}}
\newcommand{\IfCmd}{\Keyword{if}}
\newcommand{\ThenCmd}{\Keyword{then}}
\newcommand{\ElseCmd}{\Keyword{else}}
\def\If#1then#2else#3{\IfCmd{}\;#1\;\ThenCmd{}\;#2\;\ElseCmd{}\;#3}
\newcommand{\Fst}{\Keyword{fst}\;}
\newcommand{\Snd}{\Keyword{snd}\;}
\newcommand{\Inj}[1]{\Keyword{inj}_{#1}\;}
\newcommand{\MatchCmd}{\Keyword{match}}
\newcommand{\WithCmd}{\Keyword{with}}
\newcommand{\EndCmd}{\Keyword{end}}
\def\Match#1with#2=>#3|#4=>#5end{\MatchCmd{}\;#1\;\WithCmd{}\;#2\Rightarrow#3 \;|\;#4\Rightarrow#5\;\EndCmd{}}
\def\MatchV[#1]#2with#3=>#4|#5=>#6end{\begin{aligned}[#1]&\MatchCmd{}\;#2\;\WithCmd{}\\ & \hspace{0.5em}#3\Rightarrow#4\\ & | \hspace{0.2em}#5\Rightarrow#6\\ &\EndCmd{}\end{aligned}}
\newcommand{\RecCmd}{\Keyword{rec}}
\long\def\Rec#1 #2:=#3{\RecCmd\; #1(#2) := #3}

\newcommand{\Tvar}{X}
\newcommand{\TvarB}{Y}
\newcommand{\TvarC}{Z}

\newcommand{\Tlam}{\Lambda\;}
\newcommand{\Tapp}[1]{#1\;\_}

\newcommand{\empelctx}{[]}
\newcommand{\elctx}{K}

\newcommand{\subst}[3]{#1{\left[#3 \middle/ #2 \right]}}

\newcommand{\empctx}{[\cdot]}
\newcommand{\ctx}{C}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Typing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\Tunit}{\mathsf{Unit}}
\newcommand{\Temp}{\mathsf{Emp}}
\newcommand{\Tnat}{\mathbb{N}} % not needed
\newcommand{\Tint}{\mathbb{Z}}
\newcommand{\Tbool}{\mathbb{B}}
\newcommand{\Tprod}[2]{#1 \times #2}
\newcommand{\Tsum}[2]{#1 + #2}
\newcommand{\Tfunc}[2]{#1 \rightarrow #2}
\newcommand{\Tall}[2]{\forall #1.\; #2}

\newcommand{\typ}{\tau}
\newcommand{\venv}{\Gamma}
\newcommand{\tenv}{\Xi}
\newcommand{\hctx}{\Sigma} % not needed
\newcommand{\empvenv}{\bullet}
\newcommand{\emptenv}{\bullet}

% Judgements
\newcommand{\jdg}[4]{#1 \; | \; #2 \; \vdash #3 : #4}
\newcommand{\jdgType}[3]{#1 \; | \; #2 \; \vdash #3}
\newcommand{\jdgRel}[6]{#1 \; | \; #2 \; \vdash #3 \approx^{#4} #5 : #6}
\newcommand{\ctxRel}[5]{\jdgRel{#1}{#2}{#3}{ctx}{#4}{#5}}

% Step
\newcommand{\step}{\rightarrow}
\newcommand{\stepS}{\rightarrow^*}

% Head-Step
\newcommand{\hstep}{\rightarrow_h}
\newcommand{\hstepRel}[2]{#1 \hstep #2}

% Logical Relation
\newcommand{\ValInp}[2]{\mathcal{V} \llbracket #1 \rrbracket_{#2}}
\newcommand{\ValInpGen}[2]{\ValInp{#1}{#2}(\val_1, \val_2)}
\newcommand{\ExpInp}[2]{\mathcal{E} \llbracket #1 \rrbracket_{#2}}
\newcommand{\VenvInp}[2]{\mathcal{G} \llbracket #1 \rrbracket_{#2}}
\newcommand{\TenvInp}[1]{\mathcal{D} \llbracket #1 \rrbracket}

\newcommand{\LogRel}[5]{\jdgRel{#1}{#2}{#3}{LR}{#4}{#5}}

% Other
\newcommand{\Val}[1]{\mathrm{Val}(#1)}
\newcommand{\map}[2]{#1 \mapsto #2}

% TODO-command
\newcommand{\todo}[1]{{\color[rgb]{.5,0,0}\textbf{$\blacktriangleright$#1$\blacktriangleleft$}}}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagestyle{empty} 
\pagenumbering{roman} 
\vspace*{\fill}\noindent{\rule{\linewidth}{1mm}\\[4ex]
{\Huge\sf Relational Reasoning\\[1ex](Relationel r√¶sonnement)}\\[4ex]
{\huge\sf Mathias Pedersen, 201808137}\\[2ex]
\noindent\rule{\linewidth}{1mm}\\[4ex]
\noindent{\Large\sf Bachelor Report (15 ECTS) in Computer Science\\[1ex]
Advisor: Amin Timany\\[1ex]
Department of Computer Science, Aarhus University\\[1ex]  
\today \\[15ex]}\\[\fill]}
\epsfig{file=logo.eps}\clearpage
\linespread{1.15}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagestyle{plain}
\chapter*{Abstract}
\addcontentsline{toc}{chapter}{Abstract}

\todo{in English\dots}

\vspace{2ex}
\begin{flushright}
  \emph{Mathias Pedersen,}\\
  \emph{Aarhus, \today.}
\end{flushright}

\tableofcontents
\cleardoublepage
\pagenumbering{arabic}
\setcounter{secnumdepth}{2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Introduction}
\label{ch:intro}

\todo{motivate and explain the problem to be addressed}

\todo{example of a citation: \cite{DBLP:conf/sas/ChristensenMS03}}
\todo{get your bibtex entries from \url{https://dblp.org/}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Definition of Language}
\label{ch:DoL}

\todo{create draft}\\
Syntax
\begin{align*}
  \expr \BNFdef & \TT \ALT & \text{(unit value)}\\
                & \var \ALT & \text{(variables)}\\
                & \Num{n} \ALT \expr + \expr \ALT \expr - \expr \ALT
                  \expr \le \expr \ALT \expr < \expr \ALT 
                  \expr = \expr \ALT & \text{(integers)}\\
                & \True \ALT \False \ALT {\If \expr then \expr else \expr} \ALT
                  & \text{(booleans)}\\
                & (\expr, \expr) \ALT \Fst \expr \ALT \Snd \expr \ALT
                  & \text{(products)}\\
                & \Inj{1} \expr \ALT \Inj{2} \expr \ALT 
                  \Match \expr with \Inj{1} \var => \expr | \Inj{2} \var => \expr end \ALT
                  & \text{(sums)}\\
                & \Rec f \var := \expr \ALT \expr \; \expr
                  & \text{(recursive functions)}\\
                & \Tlam \expr \ALT \Tapp{\expr} & \text{(polymorphism)}\\[8pt]
  \val \BNFdef  & \TT \ALT \Num{n} \ALT \True \ALT \False \ALT
                  (\val, \val) \ALT \Inj{1} \val \ALT \Inj{2} \val \ALT
                  \Rec f \var := \expr \ALT \Tlam \expr
                  & \text{(values)}\\[8pt]
  \typ \BNFdef  & \Tunit \ALT \Tint \ALT \Tbool \ALT {\Tprod \typ \typ} \ALT
                  {\Tsum \typ \typ} \ALT {\Tfunc \typ \typ} \ALT 
                  {\Tall \Tvar \typ} & \text{(types)}\\[8pt]
  \elctx \BNFdef& \empelctx \ALT 
                  \elctx + \expr \ALT \val + \elctx \ALT
                  \elctx - \expr \ALT \val - \elctx \ALT
                  \elctx \le \expr \ALT \val \le \elctx \ALT
                  \elctx < \expr \ALT \val < \elctx \ALT 
                  & \text{(evaluation context)}\\
                & \elctx = \expr \ALT \val = \elctx \ALT
                  {\If \elctx then \expr else \expr} \ALT
                  (\elctx, \expr) \ALT (\val, \elctx) \ALT
                  \Fst \elctx \ALT \Snd \elctx \ALT\\
                & \Inj{1} \elctx \ALT \Inj{2} \elctx \ALT
                  \Match \elctx with \Inj{1} \var => \expr | \Inj{2} \var => \expr end \ALT
                  \elctx \; \expr \ALT \val \; \elctx \ALT \Tapp{\elctx}
\end{align*}
\newpage
Typing rules
\begin{mathpar}
  \inferrule*[lab=T-var]
    {(\var : \typ) \in \venv}
    {\jdg{\tenv}{\venv}{\var}{\typ}}
  \and
  \inferrule*[lab=T-unit]{ }{\jdg{\tenv}{\venv}{\TT}{\Tunit}}
  \and
  \inferrule*[lab=T-int]{ }{\jdg{\tenv}{\venv}{\Num{n}}{\Tint}}
  \and
  \inferrule*[lab=T-add]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tint}} \and {\jdg{\tenv}{\venv}{\expr_2}{\Tint}}}
    {\jdg{\tenv}{\venv}{\expr_1 + \expr_2}{\Tint}}
  \and
  \inferrule*[lab=T-sub]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tint}} \and {\jdg{\tenv}{\venv}{\expr_2}{\Tint}}}
    {\jdg{\tenv}{\venv}{\expr_1 - \expr_2}{\Tint}}
  \and
  \inferrule*[lab=T-le]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tint}} \and {\jdg{\tenv}{\venv}{\expr_2}{\Tint}}}
    {\jdg{\tenv}{\venv}{\expr_1 \le \expr_2}{\Tbool}}
  \and
  \inferrule*[lab=T-lt]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tint}} \and {\jdg{\tenv}{\venv}{\expr_2}{\Tint}}}
    {\jdg{\tenv}{\venv}{\expr_1 < \expr_2}{\Tbool}}
  \and
  \inferrule*[lab=T-eq]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tint}} \and {\jdg{\tenv}{\venv}{\expr_2}{\Tint}}}
    {\jdg{\tenv}{\venv}{\expr_1 = \expr_2}{\Tbool}}
  \and
  \inferrule*[lab=T-true]{ }{\jdg{\tenv}{\venv}{\True}{\Tbool}}
  \and
  \inferrule*[lab=T-false]{ }{\jdg{\tenv}{\venv}{\False}{\Tbool}}
  \and
  \inferrule*[lab=T-if]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tbool}} \and
    {\jdg{\tenv}{\venv}{\expr_2}{\typ}} \and
    {\jdg{\tenv}{\venv}{\expr_3}{\typ}}}
    {\jdg{\tenv}{\venv}{\If \expr_1 then \expr_2 else \expr_3}{\typ}}
  \and
  \inferrule*[lab=T-pair]
    {{\jdg{\tenv}{\venv}{\expr_1}{\typ_1}} \and
    {\jdg{\tenv}{\venv}{\expr_2}{\typ_2}}}
    {\jdg{\tenv}{\venv}{(\expr_1, \expr_2)}{\Tprod{\typ_1}{\typ_2}}}
  \and
  \inferrule*[lab=T-fst]
    {\jdg{\tenv}{\venv}{\expr}{\Tprod{\typ_1}{\typ_2}}}
    {\jdg{\tenv}{\venv}{\Fst \expr}{\typ_1}}
  \and
  \inferrule*[lab=T-snd]
    {\jdg{\tenv}{\venv}{\expr}{\Tprod{\typ_1}{\typ_2}}}
    {\jdg{\tenv}{\venv}{\Snd \expr}{\typ_2}}
  \and
  \inferrule*[lab=T-inj1]{\jdg{\tenv}{\venv}{\expr}{\typ_1}}
    {\jdg{\tenv}{\venv}{\Inj{1} \expr}{\Tsum{\typ_1}{\typ_2}}}
  \and
  \inferrule*[lab=T-inj2]{\jdg{\tenv}{\venv}{\expr}{\typ_2}}
    {\jdg{\tenv}{\venv}{\Inj{2} \expr}{\Tsum{\typ_1}{\typ_2}}}
  \and
  \inferrule*[lab=T-match]
    {{\jdg{\tenv}{\venv}{\expr}{\Tsum{\typ_1}{\typ_2}}} \and
    {\jdg{\tenv}{\venv, \var : \typ_1}{\expr_2}{\typ}} \and
    {\jdg{\tenv}{\venv, \var : \typ_2}{\expr_3}{\typ}}
    }
    {\jdg{\tenv}{\venv}{\Match \expr_1 with \Inj{1} \var => \expr_2 | \Inj{2} \var => \expr_3 end}{\typ}}
  \and
  \inferrule*[lab=T-rec]
    {\jdg{\tenv}{\venv, f : \Tfunc{\typ_1}{\typ_2}, x : \typ_1}{\expr}{\typ_2}}
    {\jdg{\tenv}{\venv}{\Rec f \var := \expr}{\Tfunc{\typ_1}{\typ_2}}}
  \and
  \inferrule*[lab=T-app]
    {{\jdg{\tenv}{\venv}{\expr_1}{\Tfunc{\typ_1}{\typ_2}}} \and
    {\jdg{\tenv}{\venv}{\expr_2}{\typ_1}}
    }
    {\jdg{\tenv}{\venv}{\expr_1 \; \expr_2}{\typ_2}}
  \and
  \inferrule*[lab=T-Tlam]
    {\jdg{\tenv, \Tvar}{\venv}{\expr}{\typ}}
    {\jdg{\tenv}{\venv}{\Tlam \expr}{\Tall{\Tvar}{\typ}}}
  \and
  \inferrule*[lab=T-Tapp]
  {\jdg{\tenv}{\venv}{\expr}{\Tall{\Tvar}{\typ}}}
  {\jdg{\tenv}{\venv}{\Tapp{\expr}}{\subst{\typ}{\Tvar}{\typ'}}}
\end{mathpar}
\newpage
Dynamics
\begin{mathpar}
  \inferrule*[lab=head-step-step]
    {\hstepRel{\expr}{\expr'}}
    {\elctx[\expr] \step \elctx[\expr']}
\end{mathpar}

\begin{mathpar}
  \inferrule*[lab=E-add]{}
    {\hstepRel{\Num{n_1} + \Num{n_2}} {\Num{n_1 + n_2}}}
  \and
  \inferrule*[lab=E-sub]{}
    {\hstepRel{\Num{n_1} - \Num{n_2}} {\Num{n_1 - n_2}}}
  \and
  \inferrule*[lab=E-eq]{n_1 = n_2}
    {\hstepRel{\Num{n_1} = \Num{n_2}} {\True}}
  \and
  \inferrule*[lab=E-not-eq]{n_1 \neq n_2}
    {\hstepRel{\Num{n_1} = \Num{n_2}} {\False}}
  \and
  \inferrule*[lab=E-le]{n_1 \le n_2}
    {\hstepRel{\Num{n_1} \le \Num{n_2}} {\True}}
  \and
  \inferrule*[lab=E-not-le]{n_1 \not\le n_2}
    {\hstepRel{\Num{n_1} \le \Num{n_2}} {\False}}
  \and
  \inferrule*[lab=E-lt]{n_1 < n_2}
    {\hstepRel{\Num{n_1} < \Num{n_2}} {\True}}
  \and
  \inferrule*[lab=E-not-lt]{n_1 \not< n_2}
    {\hstepRel{\Num{n_1} < \Num{n_2}} {\False}}
  \and
  \inferrule*[lab=E-if-true]{}
    {\hstepRel{\If \True then \expr_2 else \expr_3} {\expr_2}}
  \and
  \inferrule*[lab=E-if-false]{}
    {\hstepRel{\If \False then \expr_2 else \expr_3} {\expr_3}}
  \and
  \inferrule*[lab=E-fst]{}
    {\hstepRel{\Fst (\val_1, \val_2)} {\val_1}}
  \and
  \inferrule*[lab=E-snd]{}
    {\hstepRel{\Snd (\val_1, \val_2)} {\val_2}}
  \and
  \inferrule*[lab=E-match-inj1]{}
    {\hstepRel{\Match (\Inj{1} \val) with \Inj{1} \var => \expr_2 | \Inj{2} \var => \expr_3 end}
     {\subst{\expr_2}{\var}{\val}}}
  \and
  \inferrule*[lab=E-match-inj2]{}
    {\hstepRel{\Match (\Inj{2} \val) with \Inj{1} \var => \expr_2 | \Inj{2} \var => \expr_3 end}
     {\subst{\expr_3}{\var}{\val}}}
  \and
  \inferrule*[lab=E-rec-app]{}
    {\hstepRel{(\Rec f \var := \expr) \val}
    {\subst{\subst{\expr}{f}{\Rec f \var := \expr}}{\var}{\val}}
    }
  \and
  \inferrule*[lab=E-tapp-tlam]{}{\hstepRel{\Tapp{(\Tlam \expr)}}
  {\expr}}
\end{mathpar}


% NOTES

% language is non-terminating. We can define \omega.

% types are curry-style: types are a property of a program in a language.
%   We can run the program without ever thinking about types. We can run it
%   even if we have type errors!

\begin{lemma}\label{lem:headstep_val}
  $\elctx[\expr] \hstep \expr' \land \neg (\elctx = \empelctx) \implies \Val{e}$
\end{lemma}

\begin{proof}
  This can be shown by doing case distinction on the head-step $\elctx[\expr] \hstep \expr'$. We show it here only for case E-ADD, as all the other cases are similar. \medskip\\
  So assume $\elctx[\expr] = \Num{n_1} + \Num{n_2}$, and $\expr' = \Num{n_1 + n_2}$.
  Then there are three cases: $\elctx = []$ and $\expr = \Num{n_1} + \Num{n_2}$, $\elctx = [] + \Num{n_2}$ and $\expr = \Num{n_1}$, or $\elctx = \Num{n_1} + []$ and $\expr = \Num{n_2}$. The first case raises a contradiction as we have assumed $\neg (\elctx = \empelctx)$. In the remaining two cases, we may conclude $\Val{\expr}$, as wanted.
\end{proof}


\begin{lemma}[Evaluation under Context]\label{lem:EuC}
  $ \elctx[\expr] \stepS \expr' \implies 
    \exists \expr'' . (\expr \stepS \expr'') \land\\
    \left( (\Val{\expr''} \land \elctx[\expr''] \stepS \expr') \lor
    (\neg \Val{\expr''} \land \elctx[\expr''] = \expr') \right)
    $
\end{lemma}

\begin{proof}
  So assuming $\elctx[\expr] \stepS \expr'$, we must show
  \begin{equation}\label{eqn:EuCGoal}
    \exists \expr'' . (\expr \stepS \expr'') \land 
    \left( (\Val{\expr''} \land \elctx[\expr''] \stepS \expr') \lor
    (\neg \Val{\expr''} \land \elctx[\expr''] = \expr') \right)
  \end{equation}
  We proceed by induction on the number of steps in the evaluation $\elctx[\expr] \stepS \expr'$. Let $n$ denote the number of steps taken, so that $\elctx[\expr] \step^n \expr'$.
  \begin{itemize}
    \item Base Case $n = 0$. In this case, we have that $\elctx[\expr] \step^0 \expr'$, which means that $\elctx[\expr] = \expr'$. Now use $\expr$ for $\expr''$ in \ref{eqn:EuCGoal}. We must show
    \begin{equation*}
      (\expr \stepS \expr) \land 
      \left( (\Val{\expr} \land \elctx[\expr] \stepS \expr') \lor
      (\neg \Val{\expr} \land \elctx[\expr] = \expr') \right)
    \end{equation*}
    Trivially, $\expr \stepS \expr$. For the second part, we proceed by case distinction on $\Val{\expr}$.
    \begin{itemize}
      \item $\Val{\expr}$. We have that $\elctx[\expr] \step^0 \expr'$, so $\elctx[\expr] \stepS \expr'$. Thus, we have $\Val{\expr} \land \elctx[\expr] \stepS \expr'$, which matches the left part of the "$\lor$".
      \item $\neg \Val{\expr}$. We know that $\elctx[\expr] = \expr'$, so we have $\neg \Val{\expr} \land \elctx[\expr] = \expr'$, which matches the right part of the "$\lor$".
    \end{itemize}
    
    \item Inductive Step $n = m + 1$. Now we have $\elctx[\expr] \step^{m + 1} \expr'$. By the Induction Hypothesis, we have:
    \begin{multline}\label{eqn:EuCIH}
      \forall F, f, f'. F[f] \step^m f' \implies \exists f'' . (f \stepS f'') \land \\
      \left( (\Val{f''} \land F[f''] \stepS f') \lor
      (\neg \Val{f''} \land \elctx[f''] = f') \right)
    \end{multline}
    Split the evaluation, $\elctx[\expr] \step^{m + 1} \expr'$, up, so that 
    $\elctx[\expr] \step g \land g \step^{m} \expr'$. Looking at our dynamics, we must have that $\elctx[\expr] = H[h]$, and $g = H[h']$, for some evaluation context $H$, and expressions $h$, $h'$, and $h \hstep h'$.
    There are now three possible cases. Either $\expr = h$, $\expr$ is a superexpression of $h$, or $\expr$ is a subexpression of $h$. We will consider each in turn.
    \begin{itemize}
      \item $\elctx = H$ and $\expr = h$.\\
        Then $g = H[h'] = \elctx[h']$, and $\expr \hstep h'$. 
        Furthermore, $\elctx[h'] \step^m \expr'$. Instantiate I.H. with this to get
        \begin{multline}\label{eqn:EuCC1IH}
          \exists f'' . (h' \stepS f'') \land\\
          \left((\Val{f''} \land \elctx[f''] \stepS \expr') \lor
          (\neg \Val{f''} \land \elctx[f''] = \expr') \right)
        \end{multline}
        Call this quantified expression for $f''$, and use it for $\expr''$ in \ref{eqn:EuCGoal}. We must then show
        \begin{equation*}
          (\expr \stepS f'') \land 
          \left( (\Val{f''} \land \elctx[f''] \stepS \expr') \lor
          (\neg \Val{f''} \land \elctx[f''] = \expr') \right)
        \end{equation*}
        We know that $\expr \step h'$, as $\expr \hstep h'$, and by 
        \ref{eqn:EuCC1IH}, we know that $h' \stepS f''$, so that $\expr \stepS f''$. The second part follows directly from \ref{eqn:EuCC1IH}.
      
      \item $\elctx[E[]] = H$ and $\expr = E[h]$.\\
        Then $g = H[h'] = \elctx[E[]][h'] = \elctx[E[h']]$, thus $\elctx[E[h']] \step^m \expr'$. Instantiate I.H. with this to get
        \begin{multline}\label{eqn:EuCC2IH}
          \exists f'' . (E[h'] \stepS f'') \land\\
          \left((\Val{f''} \land \elctx[f''] \stepS \expr') \lor
          (\neg \Val{f''} \land \elctx[f''] = \expr') \right)
        \end{multline}
        Call this quantified expression for $f''$, and use it for $\expr''$ in \ref{eqn:EuCGoal}. We must then show
        \begin{equation*}
          (\expr \stepS f'') \land 
          \left( (\Val{f''} \land \elctx[f''] \stepS \expr') \lor
          (\neg \Val{f''} \land \elctx[f''] = \expr') \right)
        \end{equation*}
        We know that $E[h] \step E[h']$, as $h \hstep h'$, and since $\expr = E[h]$, then $\expr \step E[h']$. By 
        \ref{eqn:EuCC2IH}, we know that $E[h'] \stepS f''$, so that $\expr \stepS f''$. The second part follows directly from \ref{eqn:EuCC2IH}.

      \item $\elctx = H[E[]]$ and $E[\expr] = h$.
        Here we have $h = E[\expr]$, so $E[\expr] \hstep h'$. Note that $E$ is not the empty evaluation context, as otherwise, we would be in case 1. So by lemma \ref{lem:headstep_val}, we know that $\Val{\expr}$. Now, pick $\expr$ for $\expr''$ in \ref{eqn:EuCGoal}. We must show 
        \begin{equation*}
          (\expr \stepS \expr) \land 
          \left( (\Val{\expr} \land \elctx[\expr] \stepS \expr') \lor
          (\neg \Val{\expr} \land \elctx[\expr] = \expr') \right)
        \end{equation*}
        Trivially, $\expr \stepS \expr$. We also have that $\Val{\expr}$, and since $\elctx[\expr] \step^{m + 1} \expr'$, then $\elctx[\expr] \stepS \expr'$.
    \end{itemize}
  \end{itemize}
\end{proof}

\begin{corollary}\label{cor:EuC_val}
  $\elctx[\expr] \stepS \val \implies \exists \expr'' . (\expr \stepS \expr'') \land (\Val{\expr''} \land \elctx[\expr''] \stepS \val)$
\end{corollary}
\begin{proof}
  Assuming $\elctx[\expr] \stepS \val$, we must show $\exists \expr'' . (\expr \stepS \expr'') \land (\Val{\expr''} \land \elctx[\expr''] \stepS \val)$.
  By lemma \ref*{lem:EuC}, we know $\exists \expr'' . (\expr \stepS \expr'') \land ((\Val{\expr''} \land \elctx[\expr''] \stepS \val) \lor
  (\neg \Val{\expr''} \land \elctx[\expr''] = \val))$. Now, if $\neg \Val{\expr''}$ then $\neg \Val{\elctx[\expr'']}$, which one may see simply by inspecting the possible evaluation contexts. Therefore, $\elctx[\expr''] \neq \val$, so $\neg(\neg \Val{\expr''} \land \elctx[\expr''] = \val)$. Thus, we conclude $\exists \expr'' . (\expr \stepS \expr'') \land (\Val{\expr''} \land \elctx[\expr''] \stepS \val)$.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Contextual Equivalence}
\label{ch:CE}

\todo{draft}\\
Imagine you are writing a larger program, and as part of that program, you need to use a stack. So as part of your program, you implement a stack. However, your implementation is naive, and not efficient. Thus you implement a new stack, that is more complex, but also more efficient. You would of course want to use the more efficient stack implementation in your larger program, but since it is more complex, you are not really sure whether you can justify the refactoring ‚Äì the implementations might show differing behaviour.\\
What you want to show, then, is that your two stack implementation \textit{behaves} the same. In other words, no matter which \textit{context} you use your two stack implementations in, they will always behave the same as part of the context. This is intuitively what we want to define with \textit{Contextual Equivalence}.\\
In this section we give two equivalent definitions of what it means for programs to be contextually equivalent. The first definition will be more intuitive and instructive, while the second will give a deeper insight into the theoretical underpinnings of contextual equivalence.

\section{Definition of Contextual Equivalence}
Context
\begin{align*}
  \ctx \BNFdef& \empctx \ALT
                \ctx + \expr \ALT \expr + \ctx \ALT
                \ctx - \expr \ALT \expr - \ctx \ALT
                \ctx \le \expr \ALT \expr \le \ctx \ALT
                \ctx < \expr \ALT \expr < \ctx \ALT
                \ctx = \expr \ALT \expr = \ctx \ALT\\
              & {\If \ctx then \expr else \expr} \ALT
                {\If \expr then \ctx else \expr} \ALT
                {\If \expr then \expr else \ctx} \ALT
                (\ctx, \expr) \ALT (\expr, \ctx) \ALT\\
              & \Fst \ctx \ALT \Snd \ctx \ALT
                \Inj{1} \ctx \ALT \Inj{2} \ctx \ALT
                \Match \ctx with \Inj{1} \var => \expr | \Inj{2} \var => \expr end \ALT\\
              & \Match \expr with \Inj{1} \var => \ctx | \Inj{2} \var => \expr end \ALT\\
              & \Match \expr with \Inj{1} \var => \expr | \Inj{2} \var => \ctx end \ALT
              \Rec f \var := \ctx \ALT
              \ctx \; \expr \ALT \expr \; \ctx \ALT \Tlam \ctx \ALT \Tapp{\ctx}
\end{align*}

Context Typing
\begin{mathpar}
  \inferrule*[lab=T-ctx]
    { {\jdg{\tenv}{\venv}{\expr}{\typ}} \and 
      {\jdg{\tenv'}{\venv'}{\ctx[\expr]}{\typ'}}}
    {C : (\jdgType{\tenv}{\venv}{\typ}) \Rightarrow (\jdgType{\tenv'}{\venv'}{\typ'})}
\end{mathpar}
Read as: the context takes an expression of type $\typ$ under $\tenv, \venv$, and outputs an expression of type $\typ'$ under $\tenv', \venv'$.
\begin{definition}[Contextual Equivalence]\label{def:CE}
  We define contextual equivalence of two expressions $\expr_1$ and $\expr_2$ at type $\typ$ under $\tenv$ and $\venv$ as
  \begin{equation*}
    \begin{gathered}
      \ctxRel{\tenv}{\venv}{\expr_1}{\expr_2}{\typ}\\
      \iff\\
      \jdg{\tenv}{\venv}{\expr_1}{\typ} \quad \land \quad
      \jdg{\tenv}{\venv}{\expr_2}{\typ} \quad \land \quad\\
      \forall \ctx : (\jdgType{\tenv}{\venv}{\typ}) \Rightarrow (\jdgType{\emptenv}{\empvenv}{\Tunit}) . (\ctx[\expr_1] \Downarrow \iff \ctx[\expr_2] \Downarrow)
    \end{gathered}
  \end{equation*}
\end{definition}

We define CE so that two programs are CE when under all Contexts, one program terminates iff the other does. One may ponder whether this definition is really strong enough. If both terminate, we really want the result of the two programs to have values that are behaviourally the same, otherwise, we can certainly put them in a context, where they have different behaviour.
For integer values, for example, this means that the two values must be the same number, and for product types, this means that the first value in each pair should be behaviourally the same, and likewise with the second value in each pair.
To give an intuition as to  why this definition is strong enough, consider two contextually equivalent programs $\expr_1$ and $\expr_2$, where $\jdg{\emptenv}{\empvenv}{\expr_1}{\typ}$ and $\jdg{\emptenv}{\empvenv}{\expr_2}{\typ}$.
Note first that if both $\expr_1$ and $\expr_2$ don't terminate, then they will be behaviourally the same; if we plug them into any context, and the context makes us evaluate the expressions, both will not terminate. And if the context doesn't make us evaluate the expressions, then they have no influence in the run of the programs, so they will behave the same.

Now consider what happens if $\expr_1$ terminates with some value $\val_1$. Can we then guarantee that $\expr_2$ also terminates with some value $\val_2$, and $\val_1$ and $\val_2$ behave the same? Since $\expr_1$ and $\expr_2$ are contextually equivalent, then we can put them into any context, $\ctx$, and one will terminate if and only if the other one does.
Let's assume that $\typ = \Tint$. Then consider when $\ctx$ has the form $\If \empctx = \val_1 then \TT else \omega$. Here $\ctx[\expr_1] \Downarrow \TT$. But what about $\ctx[\expr_2]$? If $\val_2 \neq \val_1$, then our evaluation rules tell us that we will take the else branch, and hence not terminate. However, since $\expr_1$ and $\expr_2$ are contextually equivalent, and $\ctx[\expr_1]$ terminates, then we know that $\ctx[\expr_2]$ must also terminate. Hence it is not the case that $\val_2 \neq \val_1$, thus $\val_2 = \val_1$. So if our two programs of type integer are contextually equivalent, and they both don't run forever, then they must both evaluate to the same number.

Now if $\typ$ was $\Tbool$ instead, the context $\If \empctx then \TT else \omega$ would suffice in showing that $\val_2 = \val_1$. 

It becomes a little more difficult to reason about when $\typ$ is not a base-type, like $\Tint$ or $\Tbool$. Take function type, for instance. If $\expr_1$ and $\expr_2$ both evaluate down to functions, how do we know that those functions are behaviourally equivalent (in the sense of functional extensionality)? To see this, consider the following "congruence" rule:
\begin{mathpar}
  \inferrule*[lab=Cng-ctx-app]
  { { \ctxRel{\tenv}{\venv}{f}{f'}{\Tfunc{\typ}{\typ'}} } \and
    { \ctxRel{\tenv}{\venv}{t}{t'}{\typ} }
  }
  { \ctxRel{\tenv}{\venv}{f \; t}{f' \; t'}{\typ'} }
\end{mathpar}
This essentially gives us what we want: if we have two contextually equivalent functions, then, as long as we give them contextually equivalent inputs, the output will also be contextually equivalent. That output may be another function, but then this rule applies again to that output, and so on. In other words, we can keep on applying this rule until we at some point get a base type, like $\Tint$, and at that point, we know that the two numbers will be the same, by the argument made above.\\
Of course, it may happen that the output is of another non-base type, such as type abstraction. But we may do something similar for all other non-base types. However proving all of them is quite tedious, so we will here only prove the congruence rule for function types.
\begin{proof}
  By the two hypotheses of the rule, we know that $\jdg{\tenv}{\venv}{f}{\Tfunc{\typ}{\typ'}}$ and $\jdg{\tenv}{\venv}{t}{\typ}$. So by the T-APP rule, we may conclude $\jdg{\tenv}{\venv}{{f \; t}}{\typ'}$. Likewise for the prime variants. So all that remains to be shown is that $\forall \ctx : (\jdgType{\tenv}{\venv}{\typ'}) \Rightarrow (\jdgType{\emptenv}{\empvenv}{\Tunit}) . (\ctx[f \; t] \Downarrow \iff \ctx[f' \; t'] \Downarrow)$. So assume some context, $\ctx$, of the right type. Consider now the context $\ctx[\empctx \; t]$. We know that $f$ is contextually equivalent to $f'$, so $\ctx[f \; t] \Downarrow \iff \ctx[f' \; t] \Downarrow$. Now consider the context $\ctx[f' \empctx]$. Since $t$ is contextually equivalent to $t'$, then we know $\ctx[f' \; t] \Downarrow \iff \ctx[f' \; t'] \Downarrow$. In other words, we have that $\ctx[f \; t] \Downarrow \iff \ctx[f' \; t] \iff \ctx[f' \; t'] \Downarrow$, which was what we wanted.
\end{proof}
The way we have defined contextual equivalence is quite instructive and intuitive. However, one may define contextual equivalence in another, equivalent way, which gives much insight into contextual equivalence, and will make working with the logical relation later more intuitive. We will explore this alternative definition in the next section.

\section{Alternative Definition of Contextual Equivalence}
Before giving the alternative definition, we first introduce a few concepts. In the following, we shall let $R$ denote any relation over $\tenv \times \venv \times \expr \times \expr \times \typ$. I.e. $R \subseteq \tenv \times \venv \times \expr \times \expr \times \typ$. We also introduce the following notation: $R(\tenv, \venv, \expr, \expr', \typ) \triangleq \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\typ}$, and use them interchangeably.\\
Now we define two properties that a relation $R$ may have.
\begin{definition}[Adequacy]
  We say $R$ is an adequate relation when it holds for $R$ that $\jdgRel{\empvenv}{\emptenv}{\expr}{}{\expr'}{\Tunit} \implies \expr \Downarrow \iff \expr' \Downarrow$.
\end{definition}

\begin{definition}[Congruency]
  We say $R$ is a congruence relation (with respect to the typing rules) when it satisfies all the congruence rules that arises from the typing rules.
\end{definition}
For instance, the congruence rules for T-unit and T-app would be:
\begin{mathpar}
  \inferrule*[lab=Cng-unit]{ }
    {\jdgRel{\tenv}{\venv}{\TT}{}{\TT}{\Tunit}}
  \and
  \inferrule*[lab=Cng-Tapp]
    { \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\Tall{\Tvar}{\typ}} }
    { \jdgRel{\tenv}{\venv}{\Tapp{\expr}}{}{\Tapp{\expr'}}{\subst{\typ}{\Tvar}{\typ'}} }
\end{mathpar}
The remaining congruence rules can be found in the appendix (\ref{appendix:Cng}).\\
Now, we may define contextual equivalence in the following way
\begin{definition}\label{def:CE2}
  Contextual Equivalence is a relation, $CE \subseteq \tenv \times \venv \times \expr \times \expr \times \typ$, such that
  \begin{itemize}
    \item all expressions in $CE$ are well-typed
    \item $CE$ is a congruence relation
    \item $CE$ is an adequate relation
  \end{itemize}
  Finally, it is the coarsest such relation.
\end{definition}
$CE$ being the coarsest such relation means that if given a relation $R$ satisfying the three properties, then $\forall \tenv, \venv, \expr, \expr', \typ . R(\tenv, \venv, \expr, \expr', \typ) \implies CE(\tenv, \venv, \expr, \expr', \typ)$.\\
We of course have to show that this definition of Contextual Equivalence is actually equivalent to the one given in definition \ref{def:CE}:
\begin{theorem}\label{thm:CE_eq}
  $\ctxRel{\tenv}{\venv}{\expr}{\expr'}{\typ} \iff CE(\tenv, \venv, \expr, \expr', \typ)$
\end{theorem}
We will show this in two steps, where each step essentially corresponds to one way of the double implication. Each step will be phrased as a theorem.
\begin{theorem}\label{thm:CE_eq_part1}
  $\ctxRel{\tenv}{\venv}{\expr}{\expr'}{\typ} \subseteq \tenv \times \venv \times \expr \times \expr \times \typ$\text{is a congruence relation,}\\\text{ an adequate relation, and all expressions in the relation are well-typed.}
\end{theorem}
\begin{proof}
  First, the well-typedness follows directly from the definition of contextual equivalence.\\
  Second, let's show that it is an adequate relation. So assuming $\ctxRel{\empvenv}{\emptenv}{\expr}{\expr'}{\Tunit}$, we must show $\expr \Downarrow \iff \expr' \Downarrow$. We know that $\forall \ctx : (\jdgType{\emptenv}{\empvenv}{\Tunit}) \Rightarrow (\jdgType{\emptenv}{\empvenv}{\Tunit}) . (\ctx[\expr] \Downarrow \iff \ctx[\expr'] \Downarrow)$. So specifically for $C$ being the empty context, we get $\expr \Downarrow \iff \expr' \Downarrow$, which was what we wanted.\\
  To show that it is a congruence relation, we must go through all the congruence rules, and show that they hold. We did the one for function application above, Cng-ctx-app. The rest will not be shown here.
\end{proof}

To prove the next theorem, we will need to show two lemmas.
\begin{lemma}[Reflexivity]\label{lem:R_Cng_is_reflexive}
  Let $R$ be a congruence relation. Then $\jdg{\tenv}{\venv}{\expr}{\typ} \implies R(\tenv, \venv, \expr, \expr, \typ)$.
\end{lemma}
\begin{proof}
  By induction on the typing derivation of $\expr$. It follows immediately from applying the induction hypothesis and applying congruency rules. We show one case here.
  \begin{itemize}
    \item[case] T-tlam.\\
      Assuming $\jdg{\tenv}{\venv}{\Tlam \expr}{\Tall{\Tvar}{\typ}}$ and $\jdg{\tenv, \Tvar}{\venv}{\expr}{\typ}$, we must show $R(\tenv, \venv, \Tlam \expr, \Tlam \expr, \Tall{\Tvar}{\typ})$.By our induction hypothesis, we get $\jdgRel{\tenv, \Tvar}{\venv}{\expr}{}{\expr}{\typ}$. By the congruency rule $Cng-tlam$, we then get $\jdgRel{\tenv}{\venv}{\Tlam \expr}{}{\Tlam \expr}{\Tall{\Tvar}{\typ}}$, which was what we wanted.
  \end{itemize}
\end{proof}

\begin{lemma}\label{lem:CE_eq_part2_helper}
  Let $R$ be a congruence relation, then $R(\tenv, \venv, \expr, \expr', \typ) \; \land \; \ctx:(\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\typ'}) \implies R(\tenv', \venv', C[\expr], C[\expr'], \typ')$
\end{lemma}
\begin{proof}
  By induction on $\ctx$. We show here only a few interesting cases.
  For each non-base-case we show, the induction hypothesis will be $\forall \tenv, \venv, \tenv', \venv', \expr, \expr', \typ, \typ' .\\ R(\tenv, \venv, \expr, \expr', \typ) \land \ctx' : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\typ'}) \implies R(\tenv', \venv', \ctx'[\expr], \ctx'[\expr'], \typ')$, where $\ctx'$ is structurally smaller than $\ctx$.
  \begin{itemize}
    \item[case] $\ctx = \empctx$.\\
      So assuming $R(\tenv, \venv, \expr, \expr', \typ)$ and $\ctx: (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\typ'})$, we must show $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \typ')$. We may conclude that $\tenv = \tenv'$, $\venv = \venv'$, and $\typ = \typ'$, given that $\empctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv}{\venv}{\typ})$. So since $\expr = \empctx[\expr] = \ctx[\expr]$, and $\expr' = \empctx[\expr'] = \ctx[\expr']$, we get $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \typ')$, which was what we wanted.
    \item[case] $\ctx = \ctx' + \expr''$\\
      So assuming $R(\tenv, \venv, \expr, \expr', \typ)$ and $\ctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\typ'})$, we must show $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \typ')$. In this case, $\ctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\Tint})$ and $\ctx' : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv}{\venv}{\Tint})$, meaning $\typ' = \Tint$. So we have $R(\tenv, \venv, \expr, \expr', \Tint)$, and our goal then is $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \Tint)$. From the context typing and from rule T-add, we may conclude $\jdg{\tenv'}{\venv'}{\expr''}{\Tint}$. So by lemma \ref{lem:R_Cng_is_reflexive}, we know that $\jdgRel{\tenv'}{\venv'}{\expr''}{}{\expr''}{\Tint}$. And by I.H. we get $R(\tenv', \venv', \ctx'[\expr], \ctx'[\expr'], \Tint) \equiv \jdgRel{\tenv'}{\venv'}{\ctx'[\expr]}{}{\ctx'[\expr']}{\Tint}$. Finally, from the congruence rule cng-add, we get $\jdgRel{\tenv'}{\venv'}{\ctx'[\expr] + \expr''}{}{\ctx'[\expr'] + \expr''}{\Tint} \equiv \jdgRel{\tenv'}{\venv'}{\ctx[\expr]}{}{\ctx[\expr']}{\Tint}$, which was what we wanted.
    \item[case] $\ctx = \Fst \ctx'$\\
      Then $\ctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\typ_1})$ and $\ctx' : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\Tprod{\typ_1}{\typ_2}})$, so our goal is $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \typ_1)$. By I.H. we get $\jdgRel{\tenv'}{\venv'}{\ctx'[\expr]}{}{\ctx'[\expr']}{\Tprod{\typ_1}{\typ_2}}$, and by cng-fst with this, we get $\jdgRel{\tenv'}{\venv'}{\Fst \ctx'[\expr]}{}{\Fst \ctx'[\expr']}{\typ_1} \equiv \jdgRel{\tenv'}{\venv'}{\ctx[\expr]}{}{\ctx[\expr']}{\typ_1}$.
    \item[case] $\ctx = \Rec f \var := \ctx'$\\
      Then $\ctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\Tfunc{\typ_1}{\typ_2}})$ and $\ctx' : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv', f : \Tfunc{\typ_1}{\typ_2}, x : \typ_1}{\typ_2})$, so our goal is $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \Tfunc{\typ_1}{\typ_2})$. By I.H. we get $\jdgRel{\tenv'}{\venv', f : \Tfunc{\typ_1}{\typ_2}, x : \typ_1}{\ctx'[\expr]}{}{\ctx'[\expr']}{\typ_2}$, and by cng-rec with this, we get $\jdgRel{\tenv'}{\venv'}{\Rec f x := \ctx'[\expr]}{}{\Rec f x := \ctx'[\expr']}{\Tfunc{\typ_1}{\typ_2}} \equiv \jdgRel{\tenv'}{\venv'}{\ctx[\expr]}{}{\ctx[\expr']}{\Tfunc{\typ_1}{\typ_2}}$.
    \item[case] $\ctx = \ctx' \; \expr''$\\
      Then $\ctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\typ_2})$ and $\ctx' : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\Tfunc{\typ_1}{\typ_2}})$, so our goal is $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \typ_2)$. From the context-typing and T-app, we have $\jdg{\tenv'}{\venv'}{\expr''}{\typ_1}$. By lemma \ref{lem:R_Cng_is_reflexive}, we get $\jdgRel{\tenv'}{\venv'}{\expr''}{}{\expr''}{\typ_1}$. Now, by the induction hypothesis, we get $\jdgRel{\tenv'}{\venv'}{\ctx'[\expr]}{}{\ctx'[\expr']}{\Tfunc{\typ_1}{\typ_2}}$. And by cng-app with this, we get $\jdgRel{\tenv'}{\venv'}{\ctx'[\expr] \; \expr''}{}{\ctx'[\expr'] \; \expr''}{\typ_2} \equiv \jdgRel{\tenv'}{\venv'}{\ctx[\expr]}{}{\ctx[\expr]}{\typ_2}$.
    \item[case] $\ctx = \Tlam \ctx'$\\
      Then $\ctx : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv'}{\venv'}{\Tall{\Tvar}{\typ'}})$ and $\ctx' : (\jdgType{\tenv}{\venv}{\typ} \Rightarrow \jdgType{\tenv', \Tvar}{\venv'}{\typ'})$, so our goal is $R(\tenv', \venv', \ctx[\expr], \ctx[\expr'], \Tall{\Tvar}{\typ'})$. By I.H. we get $\jdgRel{\tenv', \Tvar}{\venv'}{\ctx'[\expr]}{}{\ctx'[\expr']}{\typ'}$, and by cng-tlam with this, we get $\jdgRel{\tenv'}{\venv'}{\Tlam \ctx'[\expr]}{}{\Tlam \ctx'[\expr']}{\Tall{\Tvar}{\typ'}} \equiv \jdgRel{\tenv'}{\venv'}{\ctx[\expr]}{}{\ctx[\expr']}{\Tall{\Tvar}{\typ'}}$.
  \end{itemize}
\end{proof}
With this lemma proved, we are ready to prove the next theorem.
\begin{theorem}\label{thm:CE_eq_part2}
  Let $R$ be a relation satisfying the three properties of definition \ref{def:CE2}, then $R(\tenv, \venv, \expr, \expr', \typ) \implies \ctxRel{\tenv}{\venv}{\expr}{\expr'}{\typ}$.
\end{theorem}
\begin{proof}
  So assuming $R(\tenv, \venv, \expr, \expr', \typ)$, we must show 
  $\jdg{\tenv}{\venv}{\expr}{\typ} \; \land \; \jdg{\tenv}{\venv}{\expr'}{\typ} \; \land \forall \ctx : (\jdgType{\tenv}{\venv}{\typ}) \Rightarrow (\jdgType{\emptenv}{\empvenv}{\Tunit}) . (\ctx[\expr] \Downarrow \iff \ctx[\expr'] \Downarrow)$. Again, the well-typedness follows from the fact that all expressions in $R$ are well-typed. So what remains to be shown is that $\forall \ctx : (\jdgType{\tenv}{\venv}{\typ}) \Rightarrow (\jdgType{\emptenv}{\empvenv}{\Tunit}) . (\ctx[\expr] \Downarrow \iff \ctx[\expr'] \Downarrow)$. So assume some context $C$ of the right type. By lemma \ref{lem:CE_eq_part2_helper}, we have $R(\emptenv, \empvenv, C[\expr], C[\expr'], \Tunit)$. By adequacy of $R$, we have that $\ctx[\expr] \Downarrow \iff \ctx[\expr'] \Downarrow$, which was what we wanted.
\end{proof}

Now, the proof of the two definitions of contextual equivalence being equivalent follows easily:
\begin{proof}[Proof of theorem \ref{thm:CE_eq}]
  By theorem \ref{thm:CE_eq_part1} and from the fact that $CE$ is the coarsest relation satisfying the three properties, it follows that $\ctxRel{\tenv}{\venv}{\expr}{\expr'}{\typ} \implies CE(\tenv, \venv, \expr, \expr', \typ)$.\\
  By theorem \ref{thm:CE_eq_part2} and from the fact that $CE$ is one such relation $R$, it follows that $CE(\tenv, \venv, \expr, \expr', \typ) \implies \ctxRel{\tenv}{\venv}{\expr}{\expr'}{\typ}$.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Logical Relations Model for Contextual Equivalence}
\label{ch:LR}

\todo{draft}

Logical relations model

Value interpretation
\begin{align*}
  \ValInpGen{\typ}{\rho}    &\triangleq \jdg{\emptenv}{\empvenv}{\val_1}{\rho_1(\typ)} \land \jdg{\emptenv}{\empvenv}{\val_2}{\rho_2(\typ)} \land \dots\\
  \ValInpGen{\Tunit}{\rho}  &\triangleq (\val_1, \val_2) \in \{(\TT, \TT)\}\\
  \ValInpGen{\Tint}{\rho}   &\triangleq (\val_1, \val_2) \in \{(\Num{n}, \Num{n}) \mid \Num{n} \in \Tint\}\\
  \ValInpGen{\Tbool}{\rho}  &\triangleq (\val_1, \val_2) \in \{(\True, \True), (\False, \False)\}\\
  \ValInpGen{\Tprod{\typ_1}{\typ_2}}{\rho}  &\triangleq (\val_1, \val_2) \in \{((\valB_{11}, \valB_{12}), (\valB_{21}, \valB_{22})) \mid \ValInp{\typ_1}{\rho}(\valB_{11}, \valB_{21}) \land \ValInp{\typ_2}{\rho}(\valB_{12}, \valB_{22})\}\\
  \ValInpGen{\Tsum{\typ_1}{\typ_2}}{\rho}   &\triangleq 
  \begin{aligned}[t]
    (\val_1, \val_2) \in \{(\Inj{1} \valB_1, \Inj{1} \valB_2) \mid \ValInp{\typ_1}{\rho}(\valB_1, \valB_2)\} \lor \\
    (\val_1, \val_2) \in \{(\Inj{2} \valB_1, \Inj{2} \valB_2) \mid \ValInp{\typ_2}{\rho}(\valB_1, \valB_2)\}
  \end{aligned}\\
  \ValInpGen{\Tfunc{\typ_1}{\typ_2}}{\rho}  &\triangleq 
  \begin{aligned}[t]
    (\val_1, \val_2) \in \{(\Rec f \var := \expr_1, \Rec f \var := \expr_2) \mid \forall \valB_1, \valB_2 . \ValInp{\typ_1}{\rho}(\valB_{1}, \valB_{2}) \implies\\
    \ExpInp{\typ_2}{\rho}(\subst{\subst{\expr_1}{f}{\Rec f \var := \expr_1}}{\var}{\valB_1}, \subst{\subst{\expr_2}{f}{\Rec f \var := \expr_2}}{\var}{\valB_2})\}
  \end{aligned}\\
  \ValInpGen{\Tall{\Tvar}{\typ}}{\rho}  &\triangleq 
  \begin{aligned}[t]
    (\val_1, \val_2) \in \{(\Tlam \expr_1, \Tlam \expr_2) \mid \forall \typ_1, \typ_2, R \in Rel[\typ_1, \typ_2] .\\
    \ExpInp{\typ}{\rho[\map{\Tvar}{(\typ_1, \typ_2, R)}]}(\subst{\expr_1}{\Tvar}{\typ_1}, \subst{\expr_2}{\Tvar}{\typ_2})\}
  \end{aligned}\\
  \ValInpGen{\Tvar}{\rho} &\triangleq (\val_1, \val_2) \in \rho_R[\Tvar]\\
\end{align*}

Relational substitution
\begin{align*}
  Rel[\typ_1, \typ_2] \triangleq 
  \left\{R \; \middle\vert \;
  \begin{aligned}
    R \in \mathcal{P}(Val \times Val) \land \jdgType{\emptenv}{\empvenv}{\typ_1} \land \jdgType{\emptenv}{\empvenv}{\typ_1} \land\\ \forall (\val_1, \val_2) \in R . \jdg{\emptenv}{\empvenv}{\val_1}{\typ_1} \land \jdg{\emptenv}{\empvenv}{\val_2}{\typ_2}
  \end{aligned}
  \right\}
\end{align*}

Expression interpretation
\begin{align*}
  \ExpInp{\typ}{\rho}(\expr_1, \expr_2) &\triangleq 
  \begin{aligned}[t]
    \jdg{\emptenv}{\empvenv}{\expr_1}{\rho_1(\typ)} \land \jdg{\emptenv}{\empvenv}{\expr_2}{\rho_2(\typ)} \land \expr_1 \Downarrow \iff \expr_2 \Downarrow \land\\
    (\forall \val_1, \val_2 . \expr_1 \Downarrow \val_1 \land \expr_2 \Downarrow \val_2 \implies \ValInpGen{\typ}{\rho})
  \end{aligned}
\end{align*}

Variable environment interpretation
\begin{align*}
  \VenvInp{\empvenv}{\rho} &\triangleq \{ \emptyset \}\\
  \VenvInp{\venv, \var : \typ}{\rho} &\triangleq \{\gamma[\map{\var}{(\val_1, \val_2)}] \mid \gamma \in \VenvInp{\venv}{\rho} \land \ValInpGen{\typ}{\rho}\}
\end{align*}

Type environment interpretation
\begin{align*}
  \TenvInp{\empvenv} &\triangleq \{ \emptyset \}\\
  \TenvInp{\tenv, \Tvar} &\triangleq \{\rho[\map{\Tvar}{(\typ_1, \typ_2, R)}] \mid \rho \in \TenvInp{\tenv} \land R \in Rel[\typ_1, \typ_2]\}
\end{align*}

\begin{definition}[Logical relation]\label{def:LogRel}
  \begin{equation*}
    \begin{gathered}
      \LogRel{\tenv}{\venv}{\expr}{\expr'}{\typ}\\
      \iff\\
      \jdg{\tenv}{\venv}{\expr}{\typ} \; \land \; \jdg{\tenv}{\venv}{\expr'}{\typ} \; \land\\
      \forall \rho \in \TenvInp{\tenv}, \gamma \in \VenvInp{\venv}{\rho} . 
      \ExpInp{\typ}{\rho}(\rho_1(\gamma_1(\expr)), \rho_2(\gamma_2(\expr')))
    \end{gathered}
  \end{equation*}
\end{definition}


Compatibility lemmas
Essentially just congruency rules as stated in appendix (but with LR being the relation). We have to prove these (and adequacy) to show that LR ==> CE, meaning we can state theorems in terms of LR instead of CE, and then get CE as a consequence.
\begin{lemma}[Cmpt-unit]
  $\inferrule{ }{\LogRel{\tenv}{\venv}{\TT}{\TT}{\Tunit}}$
\end{lemma}
\begin{proof}
  By definition \ref*{def:LogRel}, we must show $\jdg{\tenv}{\venv}{\TT}{\Tunit} \land \jdg{\tenv}{\venv}{\TT}{\Tunit} \land\\ \forall \rho \in \TenvInp{\tenv}, \gamma \in \VenvInp{\venv}{\rho} . 
  \ExpInp{\Tunit}{\rho}(\rho_1(\gamma_1(\TT)), \rho_2(\gamma_2(\TT)))$. The well-typedness simply follows by the typing rule T-unit.\\
  So assume some $\rho \in \TenvInp{\tenv}$ and $\gamma \in \VenvInp{\venv}{\rho}$, we must show\\ $\ExpInp{\Tunit}{\rho}(\rho_1(\gamma_1(\TT)), \rho_2(\gamma_2(\TT))) \equiv \ExpInp{\Tunit}{\rho}(\TT, \TT)$. Thus, we must show four things
  \begin{enumerate}
    \item $\jdg{\emptenv}{\empvenv}{\TT}{\rho_1(\Tunit)}$
    \item $\jdg{\emptenv}{\empvenv}{\TT}{\rho_2(\Tunit)}$
    \item $\TT \Downarrow \iff \TT \Downarrow$
    \item $\forall \val_1, \val_2 . \TT \Downarrow \val_1 \land \TT \Downarrow \val_2 \implies \ValInpGen{\Tunit}{\rho})$
  \end{enumerate}
  Given that $\rho_1(\Tunit) = \rho_2(\Tunit) = \Tunit$, the well-typedness once again simply follows from typing rule T-unit. (3) holds trivially. So let's show (4). Assume some $\val_1, \val_2$, and $\TT \Downarrow \val_1$ and $\TT \Downarrow \val_2$, then we must show $\ValInpGen{\Tunit}{\rho}$. Since $\TT$ is already a value, we have $\val_1 = \val_2 = \TT$, meaning we must show $\ValInp{\Tunit}{\rho}(\TT, \TT)$. Once again, the well-typedness holds by T-unit, and we have that $(\TT, \TT) \in \{(\TT, \TT)\}$, so we are done.
\end{proof}


\begin{lemma}[Cmpt-add]
  $\inferrule
    { {\LogRel{\tenv}{\venv}{\expr_1}{\expr_1'}{\Tint}} \and
      {\LogRel{\tenv}{\venv}{\expr_2}{\expr_2'}{\Tint}} }
    {\LogRel{\tenv}{\venv}{\expr_1 + \expr_2}{\expr_1' + \expr_2'}{\Tint}}$
\end{lemma}
\begin{proof}
  So assuming 
  \begin{align}
    &\LogRel{\tenv}{\venv}{\expr_1}{\expr_1'}{\Tint}\label{cmpt-add:1}\\
    &\LogRel{\tenv}{\venv}{\expr_2}{\expr_2'}{\Tint}\label{cmpt-add:2}
  \end{align}
  we must show $\jdg{\tenv}{\venv}{\expr_1 + \expr_2}{\Tint} \land \jdg{\tenv}{\venv}{\expr_1' + \expr_2'}{\Tint} \land\\ \forall \rho \in \TenvInp{\tenv}, \gamma \in \VenvInp{\venv}{\rho} . 
  \ExpInp{\Tint}{\rho}(\rho_1(\gamma_1(\expr_1 + \expr_2)), \rho_2(\gamma_2(\expr_1' + \expr_2')))$. From \ref*{cmpt-add:1}, we have $\jdg{\tenv}{\venv}{\expr_1}{\Tint}$, and from \ref*{cmpt-add:2} we have $\jdg{\tenv}{\venv}{\expr_2}{\Tint}$. So by the T-add rule, we get $\jdg{\tenv}{\venv}{\expr_1 + \expr_2}{\Tint}$. The well-typedness of $\expr_1' + \expr_2'$ follows in the same way.\\
  So let's assume some $\rho \in \TenvInp{\tenv}$ and $\gamma \in \VenvInp{\venv}{\rho}$. We must show $\ExpInp{\Tint}{\rho}(\rho_1(\gamma_1(\expr_1 + \expr_2)), \rho_2(\gamma_2(\expr_1' + \expr_2')))$, which is equivalent to $\ExpInp{\Tint}{\rho}(\rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2)), \rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2')))$. Unfolding the expression interpretation, what we need to show is the following four points
  \begin{enumerate}
    \item $\jdg{\emptenv}{\empvenv}{\rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2))}{\rho_1(\Tint)}$
    \item $\jdg{\emptenv}{\empvenv}{\rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2'))}{\rho_2(\Tint)}$
    \item $\rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2)) \Downarrow \iff \rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2')) \Downarrow$
    \item $\forall \val_1, \val_2 . \rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2)) \Downarrow \val_1 \land \rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2')) \Downarrow \val_2 \implies \ValInpGen{\Tint}{\rho})$
  \end{enumerate}
  To prove these points, we will need to use some more information. From the last part of \ref*{cmpt-add:1} instantiated with $\rho$ and $\gamma$, we get
  \begin{align}
    &\jdg{\emptenv}{\empvenv}{\rho_1(\gamma_1(\expr_1))}{\rho_1(\Tint)}\label{cmpt-add:1.1}\\
    &\jdg{\emptenv}{\empvenv}{\rho_2(\gamma_2(\expr_1'))}{\rho_2(\Tint)}\label{cmpt-add:1.2}\\
    &\rho_1(\gamma_1(\expr_1)) \Downarrow \iff \rho_2(\gamma_2(\expr_1')) \Downarrow\label{cmpt-add:1.3}\\
    &\forall \val_1, \val_2 . \rho_1(\gamma_1(\expr_1)) \Downarrow \val_1 \land \rho_2(\gamma_2(\expr_1')) \Downarrow \val_2 \implies \ValInpGen{\Tint}{\rho})\label{cmpt-add:1.4}
  \end{align}
  Likewise, from the last part of \ref*{cmpt-add:2} instantiated with $\rho$ and $\gamma$, we get
  \begin{align}
    &\jdg{\emptenv}{\empvenv}{\rho_1(\gamma_1(\expr_2))}{\rho_1(\Tint)}\label{cmpt-add:2.1}\\
    &\jdg{\emptenv}{\empvenv}{\rho_2(\gamma_2(\expr_2'))}{\rho_2(\Tint)}\label{cmpt-add:2.2}\\
    &\rho_1(\gamma_1(\expr_2)) \Downarrow \iff \rho_2(\gamma_2(\expr_2')) \Downarrow\label{cmpt-add:2.3}\\
    &\forall \val_1, \val_2 . \rho_1(\gamma_1(\expr_2)) \Downarrow \val_1 \land \rho_2(\gamma_2(\expr_2')) \Downarrow \val_2 \implies \ValInpGen{\Tint}{\rho})\label{cmpt-add:2.4}
  \end{align}
  Now to prove the four points above. Given that $\Tint$ is a closed type, $\rho(\Tint) = \Tint$. Thus, point 1 follows from \ref*{cmpt-add:1.1}, \ref*{cmpt-add:2.1} and the T-add rule. Similarly, point 2 follows from \ref*{cmpt-add:1.2}, \ref*{cmpt-add:2.2} and the T-add rule.\\
  To prove point 3, we need to show both ways of the implication. However, since they are similar, we just show one way here. So assume $\rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2))$, we must show $\rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2')) \Downarrow$. By definition of "$\Downarrow$", we know that $\exists \val_f . \rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2)) \stepS \val_f$. From this and two applications of corollary \ref{cor:EuC_val}, we may conclude $\exists \val_{f1} . \rho_1(\gamma_1(\expr_1)) \stepS \val_{f1}$ and $\exists \val_{f2} . \rho_1(\gamma_1(\expr_2)) \stepS \val_{f2}$. But then $\rho_1(\gamma_1(\expr_1)) \Downarrow$ and $\rho_1(\gamma_1(\expr_2)) \Downarrow$. From this and \ref*{cmpt-add:1.3} and \ref*{cmpt-add:2.3}, we get $\rho_2(\gamma_2(\expr_1')) \Downarrow$ and $\rho_2(\gamma_2(\expr_2')) \Downarrow$. Thus $\exists \val_{f1'} . \rho_2(\gamma_2(\expr_1')) \stepS \val_{f1'}$ and $\exists \val_{f2'} . \rho_2(\gamma_2(\expr_2')) \stepS \val_{f2'}$. By \ref*{cmpt-add:2.4}, we know that $\val_{f1'}$ and $\val_{f2'}$ are of type integer: $\Num{\val_{f1'}}$, $\Num{\val_{f2'}}$. So finally, we may conclude $\rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2')) \stepS \Num{\val_{f1'}} + \rho_2(\gamma_2(\expr_2')) \stepS \Num{\val_{f1'}} + \Num{\val_{f2'}} \stepS \Num{\val_{f1'}} + \Num{\val_{f2'}} \step \Num{\val_{f1'} + \val_{f2'}}$, which was what we wanted to show.\\
  The last part of the proof is point 4. So assume some $\val_1$ and $\val_2$, and $\rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2)) \Downarrow \val_1$ and $\rho_2(\gamma_2(\expr_1')) + \rho_2(\gamma_2(\expr_2')) \Downarrow \val_2$, we must show $\ValInp{\Tint}{\rho}(\val_1, \val_2)$. By two applications of corollary \ref{cor:EuC_val} on $\rho_1(\gamma_1(\expr_1)) + \rho_1(\gamma_1(\expr_2)) \stepS \val_1$, we get $\rho_1(\gamma_1(\expr_1)) \Downarrow \val_{11}$,  $\rho_1(\gamma_1(\expr_2)) \Downarrow \val_{12}$ and $\val_{11} + \val_{12} \stepS \val_1$, for some $\val_{11}$ and $\val_{12}$. Likewise, we get $\rho_2(\gamma_2(\expr_1')) \Downarrow \val_{21}$, $\rho_2(\gamma_2(\expr_2')) \Downarrow \val_{22}$ and $\val_{21} + \val_{22} \stepS \val_2$. From $\rho_1(\gamma_1(\expr_1)) \Downarrow \val_{11}$, $\rho_2(\gamma_2(\expr_1')) \Downarrow \val_{21}$, and \ref*{cmpt-add:1.4} we get $\ValInp{\Tint}{\rho}(\val_{11}, \val_{21})$. Similarly, from $\rho_1(\gamma_1(\expr_2)) \Downarrow \val_{12}$, $\rho_2(\gamma_2(\expr_2')) \Downarrow \val_{22}$, and \ref*{cmpt-add:2.4}, we get $\ValInp{\Tint}{\rho}(\val_{12}, \val_{22})$. We thusly know all our values are well-typed, and are in fact integers: $\Num{\val_{11}}$, $\Num{\val_{12}}$, $\Num{\val_{21}}$, $\Num{\val_{22}}$, and that $\Num{\val_{11}} = \Num{\val_{21}}$ and $\Num{\val_{12}} = \Num{\val_{22}}$. By T-add rule, we have that $\val_1$ and $\val_2$ are also well-typed, and are integers. We may then conclude $\Num{\val_{11}} + \Num{\val_{21}} \step \Num{\val_{11} + \val_{21}}$, and $\Num{\val_{21}} + \Num{\val_{22}} \step \Num{\val_{21} + \val_{22}}$, meaning $\Num{\val_{11}} + \Num{\val_{21}} = \Num{\val_1}$ and $\Num{\val_{21}} + \Num{\val_{22}} = \Num{\val_2}$. Finally, from this we get $\Num{\val_1} = \Num{\val_{11}} + \Num{\val_{21}} = \Num{\val_{21}} + \Num{\val_{22}} = \Num{\val_2}$, meaning $(\Num{\val_1}, \Num{\val_2}) \in \{(\Num{n}, \Num{n}) \mid \Num{n} \in \Tint\}$, which was what we needed to show.
\end{proof}

\begin{lemma}[Cmpt-fst]
    $\inferrule
    { \LogRel{\tenv}{\venv}{\expr}{\expr'}{\Tprod{\typ_1}{\typ_2}} }
    { \LogRel{\tenv}{\venv}{\Fst \expr}{\Fst \expr'}{\typ_1} }$
\end{lemma}
\begin{proof}
    So assuming $\LogRel{\tenv}{\venv}{\expr}{\expr'}{\Tsum{\typ_1}{\typ_2}}$, we must show (ignoring well-typedness): $\forall \rho \in \TenvInp{\tenv}, \gamma \in \VenvInp{\venv}{\rho} . \ExpInp{\typ_1}{\rho}(\rho_1 ( \gamma_1(\Fst \expr)), \rho_2(\gamma_2(\Fst \expr')))$. So assume some $\rho \in \TenvInp{\tenv}$, and $\gamma \in \VenvInp{\venv}{\rho}$, we must show $\ExpInp{\typ_1}{\rho}(\rho_1 ( \gamma_1(\Fst \expr)), \rho_2(\gamma_2(\Fst \expr'))) \equiv \ExpInp{\typ_1}{\rho}(\Fst \rho_1 ( \gamma_1(\expr)), \Fst \rho_2(\gamma_2(\expr')))$. By definition of our expression interpretation, we must show two things
    \begin{enumerate}
        \item $\Fst \rho_1 ( \gamma_1(\expr)) \Downarrow \iff \Fst \rho_2(\gamma_2(\expr')) \Downarrow$
        \item $\forall \val_1, \val_2 . \Fst \rho_1 ( \gamma_1(\expr)) \Downarrow \val_1 \land \Fst \rho_2(\gamma_2(\expr')) \Downarrow \val_2 \implies \ValInpGen{\typ_1}{\rho})$
    \end{enumerate}
    Note first that if we instantiate our initial assumption with $\rho$ and $\gamma$, we get
    \begin{align}
        &\rho_1(\gamma_1(\expr)) \Downarrow \iff \rho_2(\gamma_2(\expr')) \Downarrow\label{cmpt-fst:1.1}\\
        &\forall \val_1, \val_2 . \rho_1(\gamma_1(\expr)) \Downarrow \val_1 \land \rho_2(\gamma_2(\expr')) \Downarrow \val_2 \implies \ValInpGen{\Tprod{\typ_1}{\typ_2}}{\rho})\label{cmpt-fst:1.2}
    \end{align}
    Now to prove the two goals. For the first part, we show only the "$\implies$" direction. So assuming $\Fst \rho_1 ( \gamma_1(\expr)) \Downarrow$, we must show $\Fst \rho_2(\gamma_2(\expr')) \Downarrow$. By definition of $\Downarrow$, we know $\exists \val . \Fst \rho_1 ( \gamma_1(\expr)) \Downarrow \val$ By corollary \ref{cor:EuC_val} on our assumption, we know $\exists \val_f . \rho_1(\gamma_1(\expr)) \stepS \val_f \land \Fst \val_f \stepS \val$. By \ref{cmpt-fst:1.1} we then get $\exists \val_{f'} . \rho_2(\gamma_2(\expr')) \Downarrow \val_{f'}$. From this and by \ref{cmpt-fst:1.2} we get $\ValInp{\Tprod{\typ_1}{\typ_2}}{\rho}(\val_f, \val_{f'})$. Thus, we know $\val_{f'} = (\varB_{21}, \varB_{22})$, for some values $\varB_{21}$, $\varB_{22}$, and we may conclude $\Fst \rho_2(\gamma_2(\expr')) \stepS \Fst \val_{f'} = \Fst (\valB_{21}, \valB_{22}) \step \valB_{21}$, where the last step is justified by the E-fst rule. Thus, $\Fst \rho_2(\gamma_2(\expr')) \Downarrow$.\\
    Next we prove the second part. So assume some $\val_1$, $\val_2$, and $\Fst \rho_1 ( \gamma_1(\expr)) \Downarrow \val_1$ and $\Fst \rho_2(\gamma_2(\expr')) \Downarrow \val_2$. We must show $\ValInpGen{\typ_1}{\rho})$. By corollary \ref{cor:EuC_val}, we get $\exists \val_f . \rho_1(\gamma_1(\expr)) \stepS \val_f \land \Fst \val_f \stepS \val_1$, and $\exists \val_{f'}. \rho_1(\gamma_1(\expr')) \stepS \val_{f'} \land \Fst \val_{f'} \stepS \val_2$. By \ref{cmpt-fst:1.2} with this, we know $\ValInp{\Tsum{\typ_1}{\typ_2}}{\rho}(\val_f, \val_{f'})$. Thus $\val_{f} = (\valB_{11}, \valB_{12})$ and $\val_{f'} = (\valB_{21}, \valB_{22})$, and $\ValInp{\typ_1}{\rho}(\valB_{11}, \valB_{21})$. So since $\Fst \rho_1(\gamma_1(\expr)) \stepS \Fst \val_{f} = \Fst (\valB_{11}, \valB_{12}) \step \valB_{11}$, then $\valB_{11} = \val_1$. Likewise $\valB_{21} = \val_2$, then $\ValInpGen{\typ_1}{\rho}$.
\end{proof}


\begin{lemma}[Cmpt-match]\ \\
    $\inferrule
    { {\LogRel{\tenv}{\venv}{\expr_1}{\expr_1'}{\Tsum{\typ_1}{\typ_2}} } \and
    { \LogRel{\tenv}{\venv, \var : \typ_1}{\expr_2}{\expr_2'}{\typ} } \and
    { \LogRel{\tenv}{\venv, \var : \typ_2}{\expr_3}{\expr_3'}{\typ} }
    }
    { \LogRel{\tenv}{\venv}{\Match \expr_1 with \Inj{1} \var => \expr_2 | \Inj{2} \var => \expr_3 end}{\Match \expr_1' with \Inj{1} \var => \expr_2' | \Inj{2} \var => \expr_3' end}{\typ} }$
\end{lemma}
\begin{proof}
    First, we introduce the following notation: $\expr = \Match \expr_1 with \Inj{1} \var => \expr_2 | \Inj{2} \var => \expr_3 end$, and $\expr' = \Match \expr_1' with \Inj{1} \var => \expr_2' | \Inj{2} \var => \expr_3' end$.
    So we assume
    \begin{align}
        &\LogRel{\tenv}{\venv}{\expr_1}{\expr_1'}{\Tsum{\typ_1}{\typ_2}}\label{cmpt-match:1}\\
        &\LogRel{\tenv}{\venv, \var : \typ_1}{\expr_2}{\expr_2'}{\typ}\label{cmpt-match:2}\\
        &\LogRel{\tenv}{\venv, \var : \typ_2}{\expr_3}{\expr_3'}{\typ}\label{cmpt-match:3}
    \end{align}
    and must show (ignoring well-typedness) $\forall \rho \in \TenvInp{\tenv}, \gamma \in \VenvInp{\venv}{\rho} . \ExpInp{\typ}{\rho}(\expr, \expr')$. So assume some $\rho \in \TenvInp{\tenv}$, and $\gamma \in \VenvInp{\venv}{\rho}$, then we must show $\ExpInp{\typ}{\rho}(\rho_1(\gamma_1(\expr)), \rho_1(\gamma_1(\expr')))$. We again introduce the following notation $f = \Match \rho_1(\gamma_1(\expr_1)) with \Inj{1} \var => \rho_1(\gamma_1(\expr_2)) | \Inj{2} \var => \rho_1(\gamma_1(\expr_3)) end$, and $f' = \Match \rho_2(\gamma_2(\expr_1')) with \Inj{1} \var => \rho_2(\gamma_2(\expr_2')) | \Inj{2} \var => \rho_2(\gamma_2(\expr_3')) end$, and note that $\rho_1(\gamma_1(\expr)) = f$ and $\rho_2(\gamma_2(\expr')) = f'$, so that we must show. $\ExpInp{\typ}{\rho}(f, f')$. This corresponds to showing
    \begin{enumerate}
        \item $f \Downarrow \iff f' \Downarrow$
        \item $\forall \val_1, \val_2 . f \Downarrow \val_1 \land f' \Downarrow \val_2 \implies \ValInpGen{\typ}{\rho})$
    \end{enumerate}
    By \ref{cmpt-match:1} instantiated with $\rho, \gamma$, we get
    \begin{align}
        &\rho_1(\gamma_1(\expr_1)) \Downarrow \iff \rho_2(\gamma_2(\expr'_1)) \Downarrow\label{cmpt-match:1.1}\\
        &\forall \val_1, \val_2 . \rho_1(\gamma_1(\expr_1)) \Downarrow \val_1 \land \rho_2(\gamma_2(\expr'_1)) \Downarrow \val_2 \implies \ValInpGen{\Tsum{\typ_1}{\typ_2}}{\rho})\label{cmpt-match:1.2}
    \end{align}
    Now let's show the first part. We show only the $\implies$ direction. So assume $f \Downarrow \equiv \exists \val_{f_1} . f \Downarrow \val_{f_1}$, we must show $f' \Downarrow$. By corollary \ref{cor:EuC_val}, we get
    $\exists \val_{1_f} . \rho_1(\gamma_1(\expr_1)) \stepS \val_{1_f} \land \Match \val_{1_f} with \Inj{1} \var => \rho_1(\gamma_1(\expr_2)) | \Inj{2} \var => \rho_1(\gamma_1(\expr_3)) end \stepS \val_{f_1}$. Now, from \ref{cmpt-match:1.1} we get $\rho_2(\gamma_2(\expr'_1)) \Downarrow$. So $\exists \val_{2_f} . \rho_2(\gamma_2(\expr'_1)) \stepS \val_{2_f}$. By \ref{cmpt-match:1.2} we know $\ValInp{\Tsum{\typ_1}{\typ_2}}{\rho}(\val_{1_f}, \val_{2_f})$. Thus, 
    $(\val_{1_f}, \val_{2_f}) \in \{(\Inj{1} \valB_1, \Inj{1} \valB_2) \mid \ValInp{\typ_1}{\rho}(\valB_1, \valB_2)\} \lor
    (\val_{1_f}, \val_{2_f}) \in \{(\Inj{2} \valB_1, \Inj{2} \valB_2) \mid \ValInp{\typ_2}{\rho}(\valB_1, \valB_2)\}$. We do case distinction on the "$\lor$", but show only the first case as they are similar. So assume $(\val_{1_f}, \val_{2_f}) \in \{(\Inj{1} \valB_1, \Inj{1} \valB_2) \mid \ValInp{\typ_1}{\rho}(\valB_1, \valB_2)\}$. Then $\val_{1_f} = \Inj{1} \valB_1$, $\val_{2_f} = \Inj{1} \valB_2$, and $\ValInp{\typ_1}{\rho}(\valB_1, \valB_2)$. So we have\\ $f \stepS \Match \Inj{1} \valB_1 with \Inj{1} \var => \rho_1(\gamma_1(\expr_2)) | \Inj{2} \var => \rho_1(\gamma_1(\expr_3)) end \step \subst{\rho_1(\gamma_1(\expr_2))}{\var}{\valB_1} \stepS \val_{f_1}$, and\\
    $f' \stepS \Match \Inj{1} \valB_2 with \Inj{1} \var => \rho_2(\gamma_2(\expr'_2)) | \Inj{2} \var => \rho_2(\gamma_2(\expr'_3)) end \step \subst{\rho_2(\gamma_2(\expr'_2))}{\var}{\valB_2}$. By \todo{do substitution lemma} $\subst{\rho_1(\gamma_1(\expr_2))}{\var}{\valB_1} = \rho_1(\gamma_1[\map{\var}{\valB_1}](\expr_2))$.
    Now, from \ref{cmpt-match:2} instantiated with $\rho, \gamma' = \gamma[\map{\var}{(\valB_1, \valB_2)}]$ we get
    \begin{align}
        &\rho_1(\gamma'_1(\expr_2)) \Downarrow \iff \rho_2(\gamma'_2(\expr'_2)) \Downarrow\label{cmpt-match:2.1}\\
        &\forall \val_1, \val_2 . \rho_1(\gamma'_1(\expr_2)) \Downarrow \val_1 \land \rho_2(\gamma'_2(\expr'_2)) \Downarrow \val_2 \implies \ValInpGen{\typ}{\rho})\label{cmpt-match:2.2}
    \end{align}
    So by \ref{cmpt-match:2.1}, we get $\rho_2(\gamma_2[\map{\var}{(\valB_1, \valB_2)}](\expr'_2)) \Downarrow$, which again, by \todo{do substitution lemma} gives us $\subst{\rho_2(\gamma_2(\expr'_2))}{\var}{\valB_2} \Downarrow$. Thus $f' \Downarrow$, which was what we wanted.\\
    Next we show the second part. So assume $\val$, $\val'$, and $f \Downarrow \val_1$ and $f' \Downarrow \val_2$, we must show $\ValInpGen{\typ}{\rho})$. By corollary \ref{cor:EuC_val}, we get $\exists \val_1 . \rho_1(\gamma_1(\expr_1)) \stepS \val_1 \land \Match \val_1 with \Inj{1} \var => \rho_1(\gamma_1(\expr_2)) | \Inj{2} \var => \rho_1(\gamma_1(\expr_3)) end \stepS \val$. Likewise $\exists \val_2 . \rho_2(\gamma_2(\expr'_1)) \stepS \val_2 \land \Match \val_2 with \Inj{1} \var => \rho_2(\gamma_2(\expr'_2)) | \Inj{2} \var => \rho_2(\gamma_2(\expr'_3)) end \stepS \val'$. By \ref{cmpt-match:1.2} we know $\ValInp{\Tsum{\typ_1}{\typ_2}}{\rho}(\val_1, \val_2)$. Thus, 
    $(\val_1, \val_2) \in \{(\Inj{1} \valB_1, \Inj{1} \valB_2) \mid \ValInp{\typ_1}{\rho}(\valB_1, \valB_2)\} \lor
    (\val_1, \val_2) \in \{(\Inj{2} \valB_1, \Inj{2} \valB_2) \mid \ValInp{\typ_2}{\rho}(\valB_1, \valB_2)\}$. We do case distinction on the "$\lor$", but show only the second case as they are similar. So assume $(\val_1, \val_2) \in \{(\Inj{2} \valB_1, \Inj{2} \valB_2) \mid \ValInp{\typ_2}{\rho}(\valB_1, \valB_2)\}$. Then $\val_1 = \Inj{2} \valB_1$, $\val_2 = \Inj{2} \valB_2$, and $\ValInp{\typ_2}{\rho}(\valB_1, \valB_2)$. So we have\\ $f \stepS \Match \Inj{2} \valB_1 with \Inj{1} \var => \rho_1(\gamma_1(\expr_2)) | \Inj{2} \var => \rho_1(\gamma_1(\expr_3)) end \step \subst{\rho_1(\gamma_1(\expr_3))}{\var}{\valB_1} \stepS \val$, and\\
    $f' \stepS \Match \Inj{2} \valB_2 with \Inj{1} \var => \rho_2(\gamma_2(\expr'_2)) | \Inj{2} \var => \rho_2(\gamma_2(\expr'_3)) end \step \subst{\rho_2(\gamma_2(\expr'_3))}{\var}{\valB_2} \stepS \val'$. By \todo{do substitution lemma} $\subst{\rho_1(\gamma_1(\expr_3))}{\var}{\valB_1} = \rho_1(\gamma_1[\map{\var}{\valB_1}](\expr_3))$, and $\subst{\rho_2(\gamma_2(\expr'_3))}{\var}{\valB_2} = \rho_2(\gamma_2[\map{\var}{\valB_2}](\expr'_3))$.
    Now, from \ref{cmpt-match:3} instantiated with $\rho, \gamma' = \gamma[\map{\var}{(\valB_1, \valB_2)}]$ we get
    \begin{align}
        &\rho_1(\gamma'_1(\expr_3)) \Downarrow \iff \rho_2(\gamma'_2(\expr'_3)) \Downarrow\label{cmpt-match:3.1}\\
        &\forall \val_1, \val_2 . \rho_1(\gamma'_1(\expr_3)) \Downarrow \val_1 \land \rho_2(\gamma'_2(\expr'_3)) \Downarrow \val_2 \implies \ValInpGen{\typ}{\rho})\label{cmpt-match:3.2}
    \end{align}
    So by \ref{cmpt-match:3.2} we get $\ValInp{\typ}{\rho}(\val, \val')$.
\end{proof}


\begin{lemma}[Cmpt-rec]
    $\inferrule
    { \LogRel{\tenv}{\venv, f : \Tfunc{\typ_1}{\typ_2}, x : \typ_1}{\expr}{\expr'}{\typ_2} }
    { \LogRel{\tenv}{\venv}{\Rec f \var := \expr}{\Rec f \var := \expr'}{\Tfunc{\typ_1}{\typ_2}} }$
\end{lemma}
\begin{proof}
    \todo{do proof}
\end{proof}


\begin{lemma}[Cmpt-app]
    $\inferrule
    { {\LogRel{\tenv}{\venv}{\expr_1}{\expr_1'}{\Tfunc{\typ_1}{\typ_2}} } \and
    { \LogRel{\tenv}{\venv}{\expr_2}{\expr_2'}{\typ_1} } }
    { \LogRel{\tenv}{\venv}{\expr_1 \; \expr_2}{\expr_1' \; \expr_2'}{\typ_2} }$
\end{lemma}
\begin{proof}
    \todo{do proof}
\end{proof}


\begin{lemma}[Cmpt-Tlam]
    $\inferrule
    { \LogRel{\tenv, \Tvar}{\venv}{\expr}{\expr'}{\typ} }
    { \LogRel{\tenv}{\venv}{\Tlam{\expr}}{\Tlam{\expr'}}{\Tall{\Tvar}{\typ}} }$
\end{lemma}
\begin{proof}
    \todo{write in proof}
\end{proof}


\begin{lemma}[Cmpt-Tapp]
    $\inferrule
    { \LogRel{\tenv}{\venv}{\expr}{\expr'}{\Tall{\Tvar}{\typ}} }
    { \LogRel{\tenv}{\venv}{\Tapp{\expr}}{\Tapp{\expr'}}{\subst{\typ}{\Tvar}{\typ'}} }$
\end{lemma}
\begin{proof}
    \todo{write in proof}
\end{proof}



% - Is it correct that, after proving compatibility lemmas and adequacy of LR, then fundamental theorem follows from proof of reflexivity of R?
%   - it follows fairly quickly by direct proof; each compatibility lemma corresponds to one case in the induction proof
%   - but do we not also just get it from R is reflexive lemma?
%   yes, we get it from R is reflexive lemma.





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Examples of Application of Contextual Equivalence}
\label{ch:ACE}

\todo{draft}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Comparison to Other Work and Ideas for Future Work}
\label{ch:COWFW}

\todo{draft}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Conclusion}
\label{ch:conclusion}

\todo{conclude on the problem statement from the introduction}

\chapter*{Acknowledgments}
\addcontentsline{toc}{chapter}{Acknowledgments}

\todo{\dots}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cleardoublepage
\addcontentsline{toc}{chapter}{Bibliography}
\bibliographystyle{plain} 
\bibliography{refs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cleardoublepage
\appendix
\chapter{The Technical Details}

\todo{\dots}

\section{Congruence Rules for Alternative Definition of Contextual Equivalence}\label{appendix:Cng}

\begin{mathpar}
  \inferrule*[lab=Cng-var]
    {(\var : \typ) \in \venv}
    {\jdgRel{\tenv}{\venv}{\var}{}{\var}{\typ} }
  \and
  \inferrule*[lab=Cng-unit]{ }{ \jdgRel{\tenv}{\venv}{\TT}{}{\TT}{\Tunit} }
  \and
  \inferrule*[lab=Cng-int]{ }{ \jdgRel{\tenv}{\venv}{\Num{n}}{}{\Num{n}}{\Tint} }
  \and
  \inferrule*[lab=Cng-add]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tint} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\Tint} } }
    { \jdgRel{\tenv}{\venv}{\expr_1 + \expr_2}{}{\expr_1' + \expr_2'}{\Tint} }
  \and
  \inferrule*[lab=Cng-sub]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tint} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\Tint} } }
    { \jdgRel{\tenv}{\venv}{\expr_1 - \expr_2}{}{\expr_1' - \expr_2'}{\Tint} }
  \and
  \inferrule*[lab=Cng-le]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tint} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\Tint} } }
    { \jdgRel{\tenv}{\venv}{\expr_1 \le \expr_2}{}{\expr_1' \le \expr_2'}{\Tbool} }
  \and
  \inferrule*[lab=Cng-lt]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tint} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\Tint} } }
    { \jdgRel{\tenv}{\venv}{\expr_1 < \expr_2}{}{\expr_1' < \expr_2'}{\Tbool} }
  \and
  \inferrule*[lab=Cng-eq]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tint} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\Tint} } }
    { \jdgRel{\tenv}{\venv}{\expr_1 = \expr_2}{}{\expr_1' = \expr_2'}{\Tbool} }
  \and
  \inferrule*[lab=Cng-true]{ }{ \jdgRel{\tenv}{\venv}{\True}{}{\True}{\Tbool} }
  \and
  \inferrule*[lab=Cng-false]{ }{ \jdgRel{\tenv}{\venv}{\False}{}{\False}{\Tbool} }
  \and
  \inferrule*[lab=Cng-if]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tbool} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\typ} } \and
    { \jdgRel{\tenv}{\venv}{\expr_3}{}{\expr_3'}{\typ} }
    }
    { \jdgRel{\tenv}{\venv}{\If \expr_1 then \expr_2 else \expr_3}{}{\If {\expr_1'} then {\expr_2'} else {\expr_3'}}{\typ} }
  \and
  \inferrule*[lab=Cng-pair]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\typ_1} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\typ_2} } }
    { \jdgRel{\tenv}{\venv}{(\expr_1,\expr_2)}{}{(\expr_1', \expr_2')}{\Tprod{\typ_1}{\typ_2}} }
  \and
  \inferrule*[lab=Cng-fst]
    { \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\Tprod{\typ_1}{\typ_2}} }
    { \jdgRel{\tenv}{\venv}{\Fst \expr}{}{\Fst \expr'}{\typ_1} }
  \and
  \inferrule*[lab=Cng-snd]
    { \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\Tprod{\typ_1}{\typ_2}} }
    { \jdgRel{\tenv}{\venv}{\Snd \expr}{}{\Snd \expr'}{\typ_2} }
  \and
  \inferrule*[lab=Cng-inj1]
    { \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\typ_1} }
    { \jdgRel{\tenv}{\venv}{\Inj{1} \expr}{}{\Inj{1} \expr'}{\Tsum{\typ_1}{\typ_2}} }
  \and
  \inferrule*[lab=Cng-inj2]
    { \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\typ_2} }
    { \jdgRel{\tenv}{\venv}{\Inj{2} \expr}{}{\Inj{2} \expr'}{\Tsum{\typ_1}{\typ_2}} }
\end{mathpar}
\begin{mathpar}
  \inferrule*[lab=Cng-match]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tsum{\typ_1}{\typ_2}} } \and
    { \jdgRel{\tenv}{\venv, \var : \typ_1}{\expr_2}{}{\expr_2'}{\typ} } \and
    { \jdgRel{\tenv}{\venv, \var : \typ_2}{\expr_3}{}{\expr_3'}{\typ} }
    }
    { \jdgRel{\tenv}{\venv}{\Match \expr_1 with \Inj{1} \var => \expr_2 | \Inj{2} \var => \expr_3 end}{}{\Match \expr_1' with \Inj{1} \var => \expr_2' | \Inj{2} \var => \expr_3' end}{\typ} }
  \and
  \inferrule*[lab=Cng-rec]
    { \jdgRel{\tenv}{\venv, f : \Tfunc{\typ_1}{\typ_2}, x : \typ_1}{\expr}{}{\expr'}{\typ_2} }
    { \jdgRel{\tenv}{\venv}{\Rec f \var := \expr}{}{\Rec f \var := \expr'}{\Tfunc{\typ_1}{\typ_2}} }
  \and
  \inferrule*[lab=Cng-app]
    { {\jdgRel{\tenv}{\venv}{\expr_1}{}{\expr_1'}{\Tfunc{\typ_1}{\typ_2}} } \and
    { \jdgRel{\tenv}{\venv}{\expr_2}{}{\expr_2'}{\typ_1} } }
    { \jdgRel{\tenv}{\venv}{\expr_1 \; \expr_2}{}{\expr_1' \; \expr_2'}{\typ_2} }
  \and
  \inferrule*[lab=Cng-Tlam]
    { \jdgRel{\tenv, \Tvar}{\venv}{\expr}{}{\expr'}{\typ} }
    { \jdgRel{\tenv}{\venv}{\Tlam{\expr}}{}{\Tlam{\expr'}}{\Tall{\Tvar}{\typ}} }
  \and
  \inferrule*[lab=Cng-Tapp]
    { \jdgRel{\tenv}{\venv}{\expr}{}{\expr'}{\Tall{\Tvar}{\typ}} }
    { \jdgRel{\tenv}{\venv}{\Tapp{\expr}}{}{\Tapp{\expr'}}{\subst{\typ}{\Tvar}{\typ'}} }
\end{mathpar}

\end{document}

